# Promptfoo Configuration for Full Dialogue Flow Testing
#
# Tests the real GenerationStack pipeline (same code as CLI) for:
#   - Loop detection (no verbatim repetition)
#   - Response variety (varied lengths & wording)
#   - Stage progression (recording → rewriting)
#   - Role adherence (patient stays patient, no AI patterns)
#
# Run with:
#   npx promptfoo eval -c promptfoo-dialogue.yaml
#   npx promptfoo view  (to inspect results)
#
# Each test runs a full multi-turn dialogue (~16 turns, ~48 LLM calls).

description: Dialogue Flow & Loop Detection

prompts:
  # Dummy prompt — the dialogue provider runs the full GenerationStack
  - "Run dialogue for vignette={{vignette_name}} max_turns={{max_turns}}"

providers:
  - id: "python:prompts/dialogue_provider.py"

defaultTest:
  assert:
    # =================================================================
    # LOOP DETECTION — the primary reason this config exists
    # =================================================================
    - type: javascript
      value: |
        // No 3+ identical consecutive patient messages
        const data = JSON.parse(output);
        const patientMsgs = data.messages
          .filter(m => m.role === 'user')
          .map(m => m.content);
        let maxRun = 1, run = 1;
        for (let i = 1; i < patientMsgs.length; i++) {
          if (patientMsgs[i] === patientMsgs[i - 1]) {
            run++;
            maxRun = Math.max(maxRun, run);
          } else {
            run = 1;
          }
        }
        return maxRun < 3;
      metric: NoConsecutiveRepeats

    - type: javascript
      value: |
        // No single patient response appears 3+ times total
        const data = JSON.parse(output);
        const patientMsgs = data.messages
          .filter(m => m.role === 'user')
          .map(m => m.content);
        const counts = {};
        for (const msg of patientMsgs) {
          counts[msg] = (counts[msg] || 0) + 1;
        }
        const maxCount = Math.max(...Object.values(counts));
        return maxCount < 3;
      metric: NoExcessiveRepetition

    # =================================================================
    # RESPONSE VARIETY — patient should not sound lobotomized
    # =================================================================
    - type: javascript
      value: |
        // Patient response word counts should have meaningful variance
        // (stdev > 2 means not all responses are the same length)
        const data = JSON.parse(output);
        const lengths = data.messages
          .filter(m => m.role === 'user')
          .map(m => m.content.split(/\s+/).length);
        const avg = lengths.reduce((a, b) => a + b, 0) / lengths.length;
        const variance = lengths.reduce((s, l) => s + Math.pow(l - avg, 2), 0) / lengths.length;
        return Math.sqrt(variance) > 2;
      metric: ResponseLengthVariety

    - type: javascript
      value: |
        // At least one patient response should be short (≤10 words)
        // and at least one should be longer (≥15 words) — like a real person
        const data = JSON.parse(output);
        const lengths = data.messages
          .filter(m => m.role === 'user')
          .map(m => m.content.split(/\s+/).length);
        const hasShort = lengths.some(l => l <= 10);
        const hasLonger = lengths.some(l => l >= 15);
        return hasShort && hasLonger;
      metric: MixOfShortAndLonger

    # =================================================================
    # STAGE PROGRESSION — dialogue should advance through IRT protocol
    # =================================================================
    - type: javascript
      value: |
        // Dialogue should reach the rewriting stage
        const data = JSON.parse(output);
        return data.stages_visited.includes('rewriting');
      metric: ReachesRewriting

    - type: javascript
      value: |
        // Recording should not consume more than 70% of total turns
        const data = JSON.parse(output);
        const recordingMsgs = data.messages.filter(
          m => m.stage === 'recording'
        ).length;
        const ratio = recordingMsgs / data.messages.length;
        return ratio <= 0.7;
      metric: RecordingNotTooLong

    # =================================================================
    # ROLE ADHERENCE — patient must stay in character across full dialogue
    # =================================================================
    - type: javascript
      value: |
        // Patient never uses therapist-like phrases across any turn
        const data = JSON.parse(output);
        const patientText = data.messages
          .filter(m => m.role === 'user')
          .map(m => m.content)
          .join(' ')
          .toLowerCase();
        const banned = [
          "that's really helpful",
          "you're doing wonderfully",
          "let's try this",
          "how does that feel",
          "as your therapist",
          "i'm here to help you",
          "you mentioned feeling",
        ];
        return !banned.some(p => patientText.includes(p));
      metric: NoRoleConfusion

    - type: javascript
      value: |
        // All patient responses should be ≤80 words (no essays)
        const data = JSON.parse(output);
        const patientMsgs = data.messages
          .filter(m => m.role === 'user')
          .map(m => m.content);
        return patientMsgs.every(
          m => m.split(/\s+/).length <= 80
        );
      metric: AllResponsesReasonableLength

    # =================================================================
    # AI WRITING PATTERNS — no AI hallmarks in any patient turn
    # =================================================================
    - type: javascript
      value: |
        // No banned AI vocabulary across the full dialogue
        const data = JSON.parse(output);
        const patientText = data.messages
          .filter(m => m.role === 'user')
          .map(m => m.content)
          .join(' ')
          .toLowerCase();
        const aiWords = [
          'whimsical', 'vibrant', 'primal', 'profound',
          'empowering', 'psychedelic', 'swirling', 'wafting',
        ];
        return !aiWords.some(w => patientText.includes(w));
      metric: NoAIVocabulary

    - type: javascript
      value: |
        // No fantasy imagery in rewriting responses
        const data = JSON.parse(output);
        const rewritingPatient = data.messages
          .filter((m, i) => {
            // Patient messages during/after rewriting stage
            // (patient messages have role 'user' and appear after
            //  a therapist rewriting message)
            if (m.role !== 'user') return false;
            // Check if previous assistant message was rewriting
            const prev = data.messages[i - 1];
            return prev && prev.stage === 'rewriting';
          })
          .map(m => m.content)
          .join(' ')
          .toLowerCase();
        const fantasy = [
          'butterfly', 'rainbow', 'magical', 'fairy',
          'unicorn', 'sparkle', 'golden light',
          'protective bubble', 'playful creature',
        ];
        return !fantasy.some(f => rewritingPatient.includes(f));
      metric: NoFantasyImagery

    # =================================================================
    # THERAPIST QUALITY — basic checks on the therapist side too
    # =================================================================
    - type: javascript
      value: |
        // No 3+ identical consecutive therapist messages
        const data = JSON.parse(output);
        const therapistMsgs = data.messages
          .filter(m => m.role === 'assistant')
          .map(m => m.content);
        let maxRun = 1, run = 1;
        for (let i = 1; i < therapistMsgs.length; i++) {
          if (therapistMsgs[i] === therapistMsgs[i - 1]) {
            run++;
            maxRun = Math.max(maxRun, run);
          } else {
            run = 1;
          }
        }
        return maxRun < 3;
      metric: TherapistNoRepeats

tests:
  # =================================================================
  # One dialogue per vignette — covers different personality types
  # =================================================================
  - description: "Dialogue - anxious patient (Maya)"
    vars:
      vignette_name: anxious
      max_turns: 16

  - description: "Dialogue - cooperative patient (Anna)"
    vars:
      vignette_name: cooperative
      max_turns: 16

  - description: "Dialogue - skeptic patient (Lara)"
    vars:
      vignette_name: skeptic
      max_turns: 16

  - description: "Dialogue - resistant patient (Marcus)"
    vars:
      vignette_name: resistant
      max_turns: 16

  - description: "Dialogue - avoidant patient (Jordan)"
    vars:
      vignette_name: avoidant
      max_turns: 16

  - description: "Dialogue - trauma patient (Sam)"
    vars:
      vignette_name: trauma
      max_turns: 16

outputPath: ./promptfoo-dialogue-results.json
