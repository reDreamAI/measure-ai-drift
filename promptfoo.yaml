# Promptfoo Configuration for Patient Agent Role & Realism Testing
# Uses the real PatientAgent pipeline (same code as CLI)

description: PatientAgent Realism & Role Testing

prompts:
  # Dummy prompt â€” the custom provider ignores this and builds
  # the real prompt via PatientAgent.get_system_prompt()
  - "Generate patient response for vignette={{vignette_name}}"

providers:
  - id: "python:prompts/patient_provider.py"

defaultTest:
  assert:
    # =====================================================================
    # ROLE CONFUSION - Patient must not act as therapist
    # =====================================================================
    - type: not-icontains
      value: "That's really helpful"
      metric: NoTherapistValidation
    - type: not-icontains
      value: "You're doing wonderfully"
      metric: NoTherapistPraise
    - type: not-icontains
      value: "Let's try this"
      metric: NoTherapistGuidance
    - type: not-icontains
      value: "How does that feel"
      metric: NoTherapistProbing
    - type: not-icontains
      value: "as your therapist"
      metric: NoTherapistIdentification
    - type: not-icontains
      value: "I'm here to help you"
      metric: NoHelperRole
    - type: not-icontains
      value: "Take your time"
      metric: NoTherapistReassurance
    - type: not-icontains
      value: "You mentioned"
      metric: NoTherapistReflection
    - type: not-icontains
      value: "What comes to mind"
      metric: NoTherapistQuestion
    - type: not-icontains
      value: "It's brave of you"
      metric: NoTherapistAffirmation

    # =====================================================================
    # FORMATTING - No structured/markdown output
    # =====================================================================
    - type: not-contains
      value: "**"
      metric: NoBoldFormatting
    - type: not-contains
      value: "<think>"
      metric: NoLeakedThinking
    - type: not-contains
      value: "</think>"
      metric: NoLeakedThinkingClose
    - type: not-contains
      value: "*("
      metric: NoStageDirections
    - type: javascript
      value: |
        // No numbered lists (e.g. "1. ", "2. ", "3. ")
        const hasNumberedList = /^\d+\.\s/m.test(output);
        return !hasNumberedList;
      metric: NoNumberedLists
    - type: javascript
      value: |
        // No bullet points at start of lines
        const hasBullets = /^[\-\*]\s/m.test(output);
        return !hasBullets;
      metric: NoBulletPoints

    # =====================================================================
    # LENGTH - Responses should be concise like real speech
    # =====================================================================
    - type: javascript
      value: |
        // Response should be under 200 words (real patients are concise)
        const wordCount = output.trim().split(/\s+/).length;
        return wordCount <= 200;
      metric: ResponseNotTooLong
    - type: javascript
      value: |
        // Response should be at least 5 words (not empty/degenerate)
        const wordCount = output.trim().split(/\s+/).length;
        return wordCount >= 5;
      metric: ResponseNotEmpty

    # =====================================================================
    # REALISM - LLM judge for overall quality
    # Uncomment when you have OPENAI_API_KEY set (or configure a
    # different grading provider). Promptfoo uses OpenAI by default
    # for llm-rubric evaluation.
    # =====================================================================
    # - type: llm-rubric
    #   value: |
    #     You are evaluating whether an AI-generated therapy patient response sounds like a REAL PERSON talking in a therapy session, not like an AI writing an essay.
    #
    #     SIGNS OF A REALISTIC PATIENT (score 1.0):
    #     - Short, conversational responses (1-6 sentences typical)
    #     - Uses first-person ("I", "me", "my") to describe own experience
    #     - May include natural speech patterns: "um", "like", "I don't know", trailing off with "..."
    #     - Incomplete thoughts, contradictions, or difficulty finding words
    #     - Answers the therapist's question from personal experience
    #     - Shows genuine emotion through HOW they speak, not by analyzing it
    #
    #     SIGNS OF AN UNREALISTIC RESPONSE (score 0.0):
    #     - Multi-paragraph essay-like structure with clear topic sentences
    #     - Bullet points, numbered lists, bold text, or any formatting
    #     - Patient acts like a therapist: gives guidance, validates, offers options
    #     - Patient addresses themselves by name or narrates in third person
    #     - Perfectly articulate emotional analysis with no hesitation
    #     - Stage directions in parentheses like *(she pauses)*
    #     - Leaked <think> tags or chain-of-thought reasoning
    #
    #     Score the response:
    #     1.0 = Sounds like a real person in therapy
    #     0.5 = Partially realistic but has some AI-essay qualities
    #     0.0 = Reads like an AI/essay, not a real person
    #   metric: OverallRealism

tests:
  # =====================================================================
  # COOPERATIVE PATIENT (Anna) - Recording stage
  # =====================================================================
  - description: "Cooperative - nightmare probe"
    vars:
      vignette_name: cooperative
      therapist_message: "Can you tell me more about what happens in the nightmare?"

  - description: "Cooperative - emotion probe"
    vars:
      vignette_name: cooperative
      therapist_message: "How did that make you feel when you woke up?"

  # =====================================================================
  # COOPERATIVE PATIENT - Rewriting stage
  # =====================================================================
  - description: "Cooperative - rescripting invitation"
    vars:
      vignette_name: cooperative
      therapist_message: "How could you change this scene to make it less frightening?"

  - description: "Cooperative - receiving validation (trap)"
    vars:
      vignette_name: cooperative
      therapist_message: "That's a really brave insight you just shared."

  # =====================================================================
  # RESISTANT PATIENT (Marcus)
  # =====================================================================
  - description: "Resistant - gentle probe"
    vars:
      vignette_name: resistant
      therapist_message: "I understand this is difficult. Take your time."

  - description: "Resistant - nightmare probe"
    vars:
      vignette_name: resistant
      therapist_message: "Can you describe what happens in the dream?"

  # =====================================================================
  # ANXIOUS PATIENT (Maya)
  # =====================================================================
  - description: "Anxious - initial share"
    vars:
      vignette_name: anxious
      therapist_message: "What happens when the walls start closing in?"

  - description: "Anxious - rescripting doubt"
    vars:
      vignette_name: anxious
      therapist_message: "What if you could change one thing about that exam room?"

outputPath: ./promptfoo-results.json
